<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.javaclassS14.dao.SurvListDAO">

	<sql id="search">
		<if test="keyword != null and keyword != ''">
		AND
			<choose>
				<when test="'all'.equals(srchTyp)">
					(
						s.survTitle LIKE CONCAT('%', #{keyword}, '%')
						OR m.nickName LIKE CONCAT('%', #{keyword}, '%')
						OR s.survNo LIKE #{keyword}
					)
				</when>
				<when test="'title'.equals(srchTyp)">
					s.survTitle LIKE CONCAT('%', #{keyword}, '%')
				</when>
				<when test="'regid'.equals(srchTyp)">
					m.nickName LIKE CONCAT('%', #{keyword}, '%')
				</when>
				<when test="'survNo'.equals(srchTyp)">
					s.survNo = #{keyword}
				</when>
			</choose>
		</if>
	</sql>
	
	<sql id="mySearch">
		<if test="keyword != null and keyword != ''">
		AND
			survTitle LIKE CONCAT('%', #{keyword}, '%')
		</if>
		<choose>
				<when test="'useY'.equals(srchTyp)">
					AND useYn = 'y'
				</when>
				<when test="'useN'.equals(srchTyp)">
					AND useYn = 'n'
				</when>
		</choose>
	</sql>

	<select id="getSurvList" parameterType="com.spring.javaclassS14.vo.SearchVo" resultType="com.spring.javaclassS14.vo.SurveyDto">
		SELECT
			survNo, survTitle, regDate, modDate, memNick, rownum
		FROM
			(SELECT 	
				s.survNo as survNo,
				s.survTitle as survTitle,
				s.regId as regId,
				s.regDate as regDate,
				s.modDate as modDate,
				m.nickName as nickName,
				ROW_NUMBER() OVER (ORDER BY s.survNo desc) as rownum
			FROM	
				Survey as s
				LEFT JOIN users as m
				ON s.regId = m.userId
			WHERE 	
				useYn = 'y'
				AND delYn = 'n'
			<include refid="search" />
			) A
		<if test="firstRecordIndex != null and lastRecordIndex != null">
		WHERE
			rownum BETWEEN #{firstRecordIndex} AND #{lastRecordIndex}
		</if>
		;	
	</select>
	
	<select id="getListCnt" parameterType="com.spring.javaclassS14.vo.SearchVo" resultType="Integer">
		SELECT 	
			count(s.survNo)
		FROM	
			Survey as s
			LEFT JOIN users as m
			ON s.regId = m.userId
		WHERE 	
			useYn = 'y'
			AND delYn = 'n'
		<include refid="search" />
		;	
	</select>
	
	<select id="getMyList" parameterType="com.spring.javaclassS14.vo.SearchVo" resultType="com.spring.javaclassS14.vo.SurveyDto">
		SELECT
			survNo, survTitle, regDate, modDate, useYn, rownum
		FROM
			(SELECT 	
				survNo as survNo,
				survTitle as survTitle,
				useYn,
				regDate as regDate,
				modDate as modDate,
				ROW_NUMBER() OVER (ORDER BY survNo desc) as rownum
			FROM	
				Survey
			WHERE 	
				regId = #{regId}
				AND delYn = 'N'
			<include refid="mySearch" />
			) A
		<if test="firstRecordIndex != null and lastRecordIndex != null">
		WHERE
			rownum BETWEEN #{firstRecordIndex} AND #{lastRecordIndex}
		</if>
		;	
	</select>
	
	<select id="getMyCnt" parameterType="com.spring.javaclassS14.vo.SearchVo" resultType="Integer">
		SELECT 	
			count(*)
		FROM	
			Survey
		WHERE 	
			regId = #{regId}
			AND delYn = 'N'
		<include refid="mySearch" />
		;	
	</select>
	
	<select id="getOneSurv" parameterType="int" resultType="com.spring.javaclassS14.vo.SurveyDto">
		SELECT 	
			survNo as survNo,
			survTitle as survTitle,
			survDesc as survDesc,
			regId as regId,
			useYn,
			delYn,
			regDate as regDate,
			modDate as modDate
		FROM	
			Survey
		WHERE 	
			survNo = #{survNo}
		;	
	</select>
	
	<select id="getSurvQust" parameterType="Integer" resultType="com.spring.javaclassS14.vo.SurvqustDto">
		SELECT 	
			questNo as qustNo,
			questContent as qustCont,
			questType as qustType,
			questOrder as qustSeq
		FROM	
			survQuest
		WHERE 	
			survNo = #{survNo}
		;	
	</select>
	
	<select id="getAnswer" parameterType="Integer" resultType="com.spring.javaclassS14.vo.AnswerDto">
		SELECT 	
			count(*) as count,
			ansContent as answCont
		FROM	
			Answer
		WHERE 	
			questNo = #{qustNo}
		GROUP BY ansContent
		;	
	</select>
	
	<select id="getLongAnswer" parameterType="Integer" resultType="com.spring.javaclassS14.vo.AnswerDto">
		SELECT 	
			ansLong as answLong
		FROM	
			Answer
		WHERE 	
			questNo = #{qustNo}
		;	
	</select>
	
	<select id="getRegNick" parameterType="com.spring.javaclassS14.vo.SurveyDto" resultType="String">
		SELECT 	
				m.nickName as memNick
			FROM	
				Survey as s
				LEFT JOIN users as m
				ON s.regId = m.userId
			WHERE
				s.regId = #{regId}
				AND s.survNo = #{survNo}
		;
	</select>






</mapper>